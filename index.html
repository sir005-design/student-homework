<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加分與追蹤作業系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        input[type="text"], input[type="number"], select, textarea {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
        }
        .task-status-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        .task-name-header {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .task-name-header:hover {
            transform: scale(1.05);
        }
        .table-container {
            overflow-x: auto;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
            border-right: 1px solid #e5e7eb;
        }
        .enlarged-header {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
        }
        /* 調整作業名稱的寬度以限制字數 */
        .task-header-name {
            display: block;
            max-width: 4rem; 
            word-wrap: break-word;
            white-space: normal;
        }
        .note-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        /* 修正切換模式按鈕位置 */
        .task-column-header {
            text-align: center;
            vertical-align: top;
        }
    </style>
</head>
<body>

<div class="main-container space-y-8">
    <div class="card">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">班級加分與作業追蹤系統</h1>
        <div id="auth-container" class="text-center mb-6">
            <button id="google-login-btn" class="btn bg-blue-500 text-white hover:bg-blue-600 hidden">使用 Google 登入</button>
            <p id="user-info" class="text-gray-500 hidden">您目前的使用者ID：<span id="user-id" class="font-mono text-sm bg-gray-100 p-1 rounded"></span></p>
        </div>
        
        <div id="app-content" class="hidden">
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <div class="flex-1">
                    <h2 class="text-2xl font-semibold mb-4">班級管理</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="class-name-input" class="w-full" placeholder="輸入新班級名稱...">
                        <button id="add-class-btn" class="btn bg-blue-500 text-white hover:bg-blue-600">新增班級</button>
                    </div>
                    <ul id="class-list" class="space-y-2"></ul>
                </div>
                
                <div class="flex-1">
                    <h2 class="text-2xl font-semibold mb-4">學生管理</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="student-name-input" class="w-full" placeholder="輸入單一學生姓名...">
                        <button id="add-student-btn" class="btn bg-green-500 text-white hover:bg-green-600">新增學生</button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <textarea id="student-list-input" rows="4" placeholder="在此貼上或輸入多個學生姓名，可用逗號或換行分隔..."></textarea>
                        <button id="import-students-btn" class="btn bg-green-500 text-white hover:bg-green-600">匯入多位學生</button>
                    </div>
                </div>
            </div>
            
            <div class="card overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="class-name-header" class="text-2xl font-semibold">班級學生成績</h2>
                    <div class="flex gap-2">
                        <button id="show-pending-btn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300">顯示待處理作業學生</button>
                    </div>
                </div>
                
                <div class="mb-4 flex flex-wrap gap-2">
                    <input type="text" id="task-name-input" class="flex-1 min-w-[200px]" placeholder="輸入新作業名稱...">
                    <button id="add-task-btn" class="btn bg-purple-500 text-white hover:bg-purple-600">新增作業</button>
                </div>
                
                <div id="table-container" class="min-w-max">
                    </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 items-center justify-end">
                    <label for="task-select" class="font-medium text-gray-700">選擇要刪除的作業:</label>
                    <select id="task-select" class="flex-1 min-w-[150px]"></select>
                    <button id="delete-task-btn" class="btn bg-red-500 text-white hover:bg-red-600">刪除作業</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="modal-message" class="mb-4"></p>
        <div id="modal-content" class="mb-4"></div>
        <div class="flex justify-end gap-2">
            <button id="modal-cancel-btn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">取消</button>
            <button id="modal-confirm-btn" class="btn bg-red-500 text-white hover:bg-red-600">確定</button>
        </div>
    </div>
</div>

<div id="note-modal" class="hidden">
    <div class="overlay" onclick="closeNoteModal()"></div>
    <div class="note-modal">
        <h3 class="text-xl font-bold mb-4">作業註記：<span id="note-modal-task-name"></span></h3>
        <textarea id="note-modal-textarea" class="w-full h-40 p-2 text-base border rounded-md mb-4" placeholder="輸入註記..."></textarea>
        <div class="flex justify-end gap-2">
            <button onclick="closeNoteModal()" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">取消</button>
            <button onclick="saveNoteAndClose()" class="btn bg-blue-500 text-white hover:bg-blue-600">儲存</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase Log Level
    setLogLevel('Debug');

    // Global variables
    let db, auth, userId;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // 從 Firebase 專案設定中複製的內容
    const firebaseConfig = {
      apiKey: "AIzaSyDBlQzMZL5QkVhvTs3-tGF3nmhveb23Zo4",
      authDomain: "student-tracking-app-9f136.firebaseapp.com",
      projectId: "student-tracking-app-9f136",
      storageBucket: "student-tracking-app-9f136.firebasestorage.app",
      messagingSenderId: "15993048739",
      appId: "1:15993048739:web:2fbc5919d1f748f848b916",
      measurementId: "G-Z01NSR64CR"
    };

    let currentClassId = '';
    let currentFilter = 'all'; // 'all', 'pending'

    // UI Elements
    const userInfoEl = document.getElementById('user-info');
    const userIdEl = document.getElementById('user-id');
    const appContent = document.getElementById('app-content');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const classNameInput = document.getElementById('class-name-input');
    const addClassBtn = document.getElementById('add-class-btn');
    const classListEl = document.getElementById('class-list');
    const studentNameInput = document.getElementById('student-name-input');
    const addStudentBtn = document.getElementById('add-student-btn');
    const studentListInput = document.getElementById('student-list-input');
    const importStudentsBtn = document.getElementById('import-students-btn');
    const taskNameInput = document.getElementById('task-name-input');
    const addTaskBtn = document.getElementById('add-task-btn');
    const tableContainer = document.getElementById('table-container');
    const showPendingBtn = document.getElementById('show-pending-btn');
    const classNameHeader = document.getElementById('class-name-header');
    const taskSelect = document.getElementById('task-select');
    const deleteTaskBtn = document.getElementById('delete-task-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalContent = document.getElementById('modal-content');
    const noteModal = document.getElementById('note-modal');
    const noteModalTaskName = document.getElementById('note-modal-task-name');
    const noteModalTextarea = document.getElementById('note-modal-textarea');

    // Firebase Initialization & Authentication
    async function initFirebase() {
        if (!firebaseConfig || !firebaseConfig.projectId) {
            console.error("Firebase config is missing. Cannot initialize Firebase.");
            return;
        }
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Listen for user authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 如果偵測到使用者已登入，顯示應用程式內容並隱藏登入按鈕
                    userId = user.uid;
                    userIdEl.textContent = userId;
                    userInfoEl.classList.remove('hidden');
                    googleLoginBtn.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    console.log("User signed in with ID:", userId);
                    startDataListeners();
                } else {
                    // 如果沒有使用者登入，隱藏應用程式內容並顯示 Google 登入按鈕
                    userId = null;
                    userInfoEl.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    console.log("User signed out.");
                }
            });
            
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }

    // Handle Google Sign-In
    async function handleGoogleSignIn() {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            console.log("Google sign-in successful.");
        } catch (error) {
            console.error("Google sign-in failed:", error);
            showModal('登入錯誤', 'Google 登入失敗。請確認您的瀏覽器設定，並確保已將此網頁網域加入 Firebase 的信任網域清單。', null, null);
        }
    }


    // Start data listeners
    function