<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加分與追蹤作業系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        input[type="text"], input[type="number"], select, textarea {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
        }
        .task-status-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        .task-name-header {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .task-name-header:hover {
            transform: scale(1.05);
        }
        .table-container {
            overflow-x: auto;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
            border-right: 1px solid #e5e7eb;
        }
        .enlarged-header {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
        }
        /* 調整作業名稱的寬度以限制字數 */
        .task-header-name {
            display: block;
            max-width: 4rem; 
            word-wrap: break-word;
            white-space: normal;
        }
        .note-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        /* 修正切換模式按鈕位置 */
        .task-column-header {
            text-align: center;
            vertical-align: top;
        }
    </style>
</head>
<body>

<div class="main-container space-y-8">
    <div class="card">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">班級加分與作業追蹤系統</h1>
        <div id="auth-container" class="text-center mb-6">
            <button id="google-login-btn" class="btn bg-blue-500 text-white hover:bg-blue-600 hidden">使用 Google 登入</button>
            <p id="user-info" class="text-gray-500 hidden">您目前的使用者ID：<span id="user-id" class="font-mono text-sm bg-gray-100 p-1 rounded"></span></p>
        </div>
        
        <div id="app-content" class="hidden">
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <!-- 班級管理 -->
                <div class="flex-1">
                    <h2 class="text-2xl font-semibold mb-4">班級管理</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="class-name-input" class="w-full" placeholder="輸入新班級名稱...">
                        <button id="add-class-btn" class="btn bg-blue-500 text-white hover:bg-blue-600">新增班級</button>
                    </div>
                    <ul id="class-list" class="space-y-2"></ul>
                </div>
                
                <!-- 學生管理 -->
                <div class="flex-1">
                    <h2 class="text-2xl font-semibold mb-4">學生管理</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="student-name-input" class="w-full" placeholder="輸入單一學生姓名...">
                        <button id="add-student-btn" class="btn bg-green-500 text-white hover:bg-green-600">新增學生</button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <textarea id="student-list-input" rows="4" placeholder="在此貼上或輸入多個學生姓名，可用逗號或換行分隔..."></textarea>
                        <button id="import-students-btn" class="btn bg-green-500 text-white hover:bg-green-600">匯入多位學生</button>
                    </div>
                </div>
            </div>
            
            <!-- 主要表格區塊 -->
            <div class="card overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="class-name-header" class="text-2xl font-semibold">班級學生成績</h2>
                    <div class="flex gap-2">
                        <button id="show-pending-btn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300">顯示待處理作業學生</button>
                    </div>
                </div>
                
                <div class="mb-4 flex flex-wrap gap-2">
                    <input type="text" id="task-name-input" class="flex-1 min-w-[200px]" placeholder="輸入新作業名稱...">
                    <button id="add-task-btn" class="btn bg-purple-500 text-white hover:bg-purple-600">新增作業</button>
                </div>
                
                <div id="table-container" class="min-w-max">
                    <!-- 表格內容將由 JS 動態生成 -->
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 items-center justify-end">
                    <label for="task-select" class="font-medium text-gray-700">選擇要刪除的作業:</label>
                    <select id="task-select" class="flex-1 min-w-[150px]"></select>
                    <button id="delete-task-btn" class="btn bg-red-500 text-white hover:bg-red-600">刪除作業</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 彈出視窗模組 (用作通用提示) -->
<div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="modal-message" class="mb-4"></p>
        <div id="modal-content" class="mb-4"></div>
        <div class="flex justify-end gap-2">
            <button id="modal-cancel-btn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">取消</button>
            <button id="modal-confirm-btn" class="btn bg-red-500 text-white hover:bg-red-600">確定</button>
        </div>
    </div>
</div>

<!-- 作業註記浮動視窗 -->
<div id="note-modal" class="hidden">
    <div class="overlay" onclick="closeNoteModal()"></div>
    <div class="note-modal">
        <h3 class="text-xl font-bold mb-4">作業註記：<span id="note-modal-task-name"></span></h3>
        <textarea id="note-modal-textarea" class="w-full h-40 p-2 text-base border rounded-md mb-4" placeholder="輸入註記..."></textarea>
        <div class="flex justify-end gap-2">
            <button onclick="closeNoteModal()" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">取消</button>
            <button onclick="saveNoteAndClose()" class="btn bg-blue-500 text-white hover:bg-blue-600">儲存</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase Log Level
    setLogLevel('Debug');

    // Global variables
    let db, auth, userId;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // 從 Firebase 專案設定中複製的內容
    const firebaseConfig = {
      apiKey: "AIzaSyDBlQzMZL5QkVhvTs3-tGF3nmhveb23Zo4",
      authDomain: "student-tracking-app-9f136.firebaseapp.com",
      projectId: "student-tracking-app-9f136",
      storageBucket: "student-tracking-app-9f136.firebasestorage.app",
      messagingSenderId: "15993048739",
      appId: "1:15993048739:web:2fbc5919d1f748f848b916",
      measurementId: "G-Z01NSR64CR"
    };

    let currentClassId = '';
    let currentFilter = 'all'; // 'all', 'pending'

    // UI Elements
    const userInfoEl = document.getElementById('user-info');
    const userIdEl = document.getElementById('user-id');
    const appContent = document.getElementById('app-content');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const classNameInput = document.getElementById('class-name-input');
    const addClassBtn = document.getElementById('add-class-btn');
    const classListEl = document.getElementById('class-list');
    const studentNameInput = document.getElementById('student-name-input');
    const addStudentBtn = document.getElementById('add-student-btn');
    const studentListInput = document.getElementById('student-list-input');
    const importStudentsBtn = document.getElementById('import-students-btn');
    const taskNameInput = document.getElementById('task-name-input');
    const addTaskBtn = document.getElementById('add-task-btn');
    const tableContainer = document.getElementById('table-container');
    const showPendingBtn = document.getElementById('show-pending-btn');
    const classNameHeader = document.getElementById('class-name-header');
    const taskSelect = document.getElementById('task-select');
    const deleteTaskBtn = document.getElementById('delete-task-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalContent = document.getElementById('modal-content');
    const noteModal = document.getElementById('note-modal');
    const noteModalTaskName = document.getElementById('note-modal-task-name');
    const noteModalTextarea = document.getElementById('note-modal-textarea');

    // Firebase Initialization & Authentication
    async function initFirebase() {
        if (!firebaseConfig || !firebaseConfig.projectId) {
            console.error("Firebase config is missing. Cannot initialize Firebase.");
            return;
        }
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Listen for user authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdEl.textContent = userId;
                    userInfoEl.classList.remove('hidden');
                    googleLoginBtn.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    console.log("User signed in with ID:", userId);
                    startDataListeners();
                } else {
                    userId = null;
                    userInfoEl.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    console.log("User signed out.");
                }
            });
            
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }

    // Handle Google Sign-In
    async function handleGoogleSignIn() {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            console.log("Google sign-in successful.");
        } catch (error) {
            console.error("Google sign-in failed:", error);
            showModal('登入錯誤', 'Google 登入失敗。請確認您的瀏覽器設定，並確保已將此網頁網域加入 Firebase 的信任網域清單。', null, null);
        }
    }


    // Start data listeners
    function startDataListeners() {
        if (!userId) return;
        const classesRef = collection(db, `artifacts/${appId}/users/${userId}/classes`);
        onSnapshot(classesRef, (snapshot) => {
            const classes = [];
            snapshot.forEach(doc => classes.push({ id: doc.id, ...doc.data() }));
            renderClassList(classes);
            // Default to the first class if one is not already selected
            if (classes.length > 0 && !currentClassId) {
                currentClassId = classes[0].id;
                renderStudentsTable();
            }
        });

        if (currentClassId) {
            renderStudentsTable();
        }
    }

    // Render class list
    function renderClassList(classes) {
        classListEl.innerHTML = '';
        classes.forEach(cls => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg hover:bg-gray-100 transition cursor-pointer';
            
            const className = document.createElement('span');
            className.textContent = cls.name;
            className.addEventListener('click', () => {
                currentClassId = cls.id;
                renderStudentsTable();
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '刪除';
            deleteBtn.className = 'text-red-500 hover:text-red-700 ml-4';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showModal('刪除班級', `確定要刪除班級「${cls.name}」嗎？`, () => deleteClass(cls.id), null);
            });

            li.append(className, deleteBtn);
            classListEl.appendChild(li);
        });
    }

    // Render students table
    function renderStudentsTable() {
        if (!currentClassId) {
            classNameHeader.textContent = `班級學生成績`;
            tableContainer.innerHTML = `<p class="text-center text-gray-500">請先選擇或新增一個班級。</p>`;
            return;
        }

        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        onSnapshot(classDocRef, (docSnap) => {
            if (!docSnap.exists()) {
                classNameHeader.textContent = `班級學生成績`;
                tableContainer.innerHTML = `<p class="text-center text-gray-500">此班級資料不存在。</p>`;
                return;
            }
            const classData = docSnap.data();
            const students = classData.students || [];
            const allTasks = classData.tasks || [];
            const taskNotes = classData.taskNotes || {};
            const className = classData.name || '未命名班級';
            
            classNameHeader.textContent = `${className}學生成績`;

            // Helper function: Convert grade to points
            const convertGradeToPoints = (grade) => {
                grade = Number(grade);
                if (grade <= 60) return 0;
                if (grade <= 80) return 1;
                if (grade <= 95) return 2;
                if (grade <= 100) return 3;
                return 0; // Out of range
            };

            // Calculate scores and points
            students.forEach(student => {
                let taskScore = 0;
                allTasks.forEach(task => {
                    const status = student.taskStatus?.[task] || { type: 'button', value: 0 };
                    if (status.type === 'button') {
                        taskScore += status.value === 2 ? 2 : (status.value === 1 ? 1 : 0);
                    } else if (status.type === 'grade') {
                        taskScore += convertGradeToPoints(status.value);
                    }
                });
                student.taskScore = taskScore;
                student.totalScore = student.taskScore + (student.manualScore || 0);
            });

            // Calculate max total score
            const maxScore = students.reduce((max, student) => Math.max(max, student.totalScore), 0);

            // Convert final grade and points
            students.forEach(student => {
                if (maxScore > 0) {
                    student.finalGrade = 75 + ((student.totalScore / maxScore) * 16);
                } else {
                    student.finalGrade = 75;
                }
                student.points = Math.min(15, Math.round((student.finalGrade - 75) * (15 / 16)));
            });

            // Filter tasks based on current filter
            const tasksToRender = allTasks.filter(task => {
                if (currentFilter === 'pending') {
                    // Hide if all students have completed
                    return !students.every(student => {
                        const status = student.taskStatus?.[task] || { type: 'button', value: 0 };
                        if (status.type === 'button') {
                            return status.value === 2;
                        } else if (status.type === 'grade') {
                            return Number(status.value) > 60;
                        }
                        return false;
                    });
                }
                return true;
            });
            
            // Filter students based on current filter
            const filteredStudents = students.filter(student => {
                if (currentFilter === 'pending') {
                    return allTasks.some(task => {
                        const status = student.taskStatus?.[task] || { type: 'button', value: 0 };
                        if (status.type === 'button') {
                            return status.value === 0 || status.value === 1;
                        } else if (status.type === 'grade') {
                            return Number(status.value) <= 60;
                        }
                        return false;
                    });
                }
                return true;
            });

            // Update task select dropdown
            taskSelect.innerHTML = allTasks.map(task => `<option value="${task}">${task}</option>`).join('');
            
            // Update filter button style
            if (currentFilter === 'pending') {
                showPendingBtn.className = 'btn bg-blue-500 text-white hover:bg-blue-600';
            } else {
                showPendingBtn.className = 'btn bg-gray-200 text-gray-800 hover:bg-gray-300';
            }

            // Dynamically generate HTML
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider sticky-col" rowspan="2">姓名</th>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">教師加分</th>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">作業分數</th>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">學期總分</th>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">平常分數<br>(75-91)</th>
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">點數<br>(0-15)</th>
            `;
            // Adjust task column spacing
            tasksToRender.forEach(task => {
                tableHTML += `<th class="px-3 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider whitespace-normal break-words cursor-pointer task-column-header">
                                <span class="task-header-name" onclick="openNoteModal('${task}')">${task}</span>
                                <button class="text-blue-500 hover:text-blue-700 text-xs font-normal mt-1" onclick="toggleColumnInputMode('${task}')">切換模式</button>
                              </th>`;
            });
            tableHTML += `
                            <th class="px-6 py-3 text-left text-lg font-semibold text-gray-800 uppercase tracking-wider" rowspan="2">操作</th>
                        </tr>
                        <tr>
                            <th class="px-6 py-3 sticky-col"></th>
                            <th colspan="5"></th>
            `;
            tasksToRender.forEach(() => {
                tableHTML += `<td class="px-3"></td>`;
            });
            tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            filteredStudents.forEach((student, index) => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-lg font-medium text-gray-900 sticky-col">${index + 1}. ${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" class="w-20 text-center" value="${student.manualScore || 0}" onchange="updateManualScore('${student.id}', this.value)">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-lg">${student.taskScore}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-lg">${student.totalScore}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-blue-600">${student.finalGrade.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-orange-500">${student.points}</td>
                `;
                tasksToRender.forEach(task => {
                    const statusObj = student.taskStatus?.[task] || { type: 'button', value: 0 };
                    let displayHTML = '';
                    if (statusObj.type === 'button') {
                        let btnBg = 'bg-gray-200';
                        let btnText = '未繳';
                        let btnPoints = 0;
                        if (statusObj.value === 2) { btnBg = 'bg-green-500'; btnText = '完成'; btnPoints = 2; } 
                        else if (statusObj.value === 1) { btnBg = 'bg-yellow-500'; btnText = '未訂'; btnPoints = 1; } 
                        else if (statusObj.value === 0) { btnBg = 'bg-red-500'; btnText = '未繳'; btnPoints = 0; }

                        displayHTML = `<button class="w-20 h-10 ${btnBg} text-white rounded-md hover:opacity-80 transition" onclick="updateTaskStatus('${student.id}', '${task}', ${statusObj.value})">${btnText} (${btnPoints})</button>`;
                    } else if (statusObj.type === 'grade') {
                        displayHTML = `
                            <div class="flex flex-col items-center gap-1">
                                <input type="number" class="w-20 text-center text-sm" value="${statusObj.value}" onchange="updateTaskGrade('${student.id}', '${task}', this.value)">
                                <span class="text-xs text-gray-500">(${convertGradeToPoints(statusObj.value)}點)</span>
                            </div>
                        `;
                    }
                    
                    tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-center">${displayHTML}</td>`;
                });
                tableHTML += `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-red-500 hover:text-red-700" onclick="deleteStudent('${student.id}')">刪除</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        });
    }

    // Handlers
    async function addClass() {
        const className = classNameInput.value.trim();
        if (className) {
            const classesRef = collection(db, `artifacts/${appId}/users/${userId}/classes`);
            await addDoc(classesRef, { name: className, students: [], tasks: [], taskNotes: {} });
            classNameInput.value = '';
            console.log("Class added.");
        }
    }

    async function deleteClass(classId) {
        if (!classId) return;
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${classId}`);
        await deleteDoc(classDocRef);
        currentClassId = ''; // Clear current selection
        tableContainer.innerHTML = `<p class="text-center text-gray-500">班級已刪除，請選擇或新增一個班級。</p>`;
        console.log("Class deleted.");
    }
    
    async function addStudent() {
        const studentName = studentNameInput.value.trim();
        if (studentName && currentClassId) {
            const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
            const classSnap = await getDoc(classDocRef);
            const classData = classSnap.data();
            
            const newStudent = {
                id: crypto.randomUUID(),
                name: studentName,
                manualScore: 0,
                taskStatus: {}
            };
            const updatedStudents = [...(classData.students || []), newStudent];
            await updateDoc(classDocRef, { students: updatedStudents });
            studentNameInput.value = '';
            console.log("Student added.");
        }
    }

    async function importStudents() {
        const studentNamesString = studentListInput.value.trim();
        if (!studentNamesString || !currentClassId) {
            return;
        }

        const names = studentNamesString.split(/[\n,]/).map(name => name.trim()).filter(name => name.length > 0);
        if (names.length === 0) {
            return;
        }

        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();
        
        const newStudents = names.map(name => ({
            id: crypto.randomUUID(),
            name: name,
            manualScore: 0,
            taskStatus: {}
        }));

        const updatedStudents = [...(classData.students || []), ...newStudents];
        await updateDoc(classDocRef, { students: updatedStudents });
        studentListInput.value = '';
        console.log("Students imported.");
    }

    async function deleteStudent(studentId) {
        if (!currentClassId || !studentId) return;
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();
        const updatedStudents = (classData.students || []).filter(s => s.id !== studentId);
        await updateDoc(classDocRef, { students: updatedStudents });
        console.log("Student deleted.");
    }

    async function addTask() {
        const taskName = taskNameInput.value.trim();
        if (taskName && currentClassId) {
            const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
            const classSnap = await getDoc(classDocRef);
            const classData = classSnap.data();
            
            const updatedTasks = [...(classData.tasks || []), taskName];
            const updatedTaskNotes = { ...classData.taskNotes, [taskName]: "" };
            await updateDoc(classDocRef, { tasks: updatedTasks, taskNotes: updatedTaskNotes });
            taskNameInput.value = '';
            console.log("Task added.");
        }
    }
    
    async function deleteTask() {
        const taskName = taskSelect.value;
        if (!currentClassId || !taskName) return;
        showModal('刪除作業', `確定要刪除作業「${taskName}」嗎？這將會清除所有學生的該作業分數與註記！`, async () => {
            const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
            const classSnap = await getDoc(classDocRef);
            const classData = classSnap.data();
            
            const updatedTasks = (classData.tasks || []).filter(t => t !== taskName);
            const updatedStudents = (classData.students || []).map(s => {
                if (s.taskStatus) {
                    delete s.taskStatus[taskName];
                }
                return s;
            });
            const updatedTaskNotes = { ...classData.taskNotes };
            delete updatedTaskNotes[taskName];

            await updateDoc(classDocRef, { tasks: updatedTasks, students: updatedStudents, taskNotes: updatedTaskNotes });
            console.log("Task deleted.");
        }, null);
    }

    async function updateTaskStatus(studentId, taskName, currentStatus) {
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();

        const student = (classData.students || []).find(s => s.id === studentId);
        if (student) {
            let nextStatus;
            if (currentStatus === 0) {
                nextStatus = 2; // Not submitted -> Completed
            } else if (currentStatus === 2) {
                nextStatus = 1; // Completed -> Not corrected
            } else if (currentStatus === 1) {
                nextStatus = 0; // Not corrected -> Not submitted
            } else {
                nextStatus = 2; // Default
            }

            student.taskStatus[taskName] = { type: 'button', value: nextStatus };
            await updateDoc(classDocRef, { students: classData.students });
            console.log("Task status updated.");
        }
    }

    async function updateTaskGrade(studentId, taskName, newGrade) {
        const grade = Math.min(100, Math.max(0, Number(newGrade)));
        if (!currentClassId || !studentId) return;

        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();

        const student = (classData.students || []).find(s => s.id === studentId);
        if (student) {
            student.taskStatus[taskName] = { type: 'grade', value: grade };
            await updateDoc(classDocRef, { students: classData.students });
            console.log("Task grade updated.");
        }
    }

    async function updateManualScore(studentId, score) {
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();

        const student = (classData.students || []).find(s => s.id === studentId);
        if (student) {
            student.manualScore = Number(score) || 0;
            await updateDoc(classDocRef, { students: classData.students });
            console.log("Manual score updated.");
        }
    }
    
    async function toggleColumnInputMode(taskName) {
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = classSnap.data();
        
        const updatedStudents = (classData.students || []).map(s => {
            const currentStatus = s.taskStatus?.[taskName] || { type: 'button', value: 0 };
            let newStatus;
            if (currentStatus.type === 'button') {
                newStatus = { type: 'grade', value: 0 };
            } else {
                newStatus = { type: 'button', value: 0 };
            }
            s.taskStatus[taskName] = newStatus;
            return s;
        });

        await updateDoc(classDocRef, { students: updatedStudents });
        console.log(`Toggled input mode for task: ${taskName}`);
    }

    async function saveTaskNote(taskName, noteContent) {
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        const classSnap = await getDoc(classDocRef);
        const classData = docSnap.data();
        const updatedTaskNotes = { ...classData.taskNotes, [taskName]: noteContent };
        await updateDoc(classDocRef, { taskNotes: updatedTaskNotes });
        console.log("Task note saved.");
    }
    
    function openNoteModal(taskName) {
        noteModal.style.display = 'block';
        noteModalTaskName.textContent = taskName;
        
        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassId}`);
        getDoc(classDocRef).then(docSnap => {
            if (docSnap.exists()) {
                const classData = docSnap.data();
                const note = (classData.taskNotes && classData.taskNotes[taskName]) || '';
                noteModalTextarea.value = note;
            }
        });
    }

    function closeNoteModal() {
        noteModal.style.display = 'none';
        noteModalTaskName.textContent = '';
        noteModalTextarea.value = '';
    }

    async function saveNoteAndClose() {
        const taskName = noteModalTaskName.textContent;
        const noteContent = noteModalTextarea.value;
        await saveTaskNote(taskName, noteContent);
        closeNoteModal();
    }

    // Modal functions (general purpose)
    function showModal(title, message, onConfirm, onCancel) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalContent.innerHTML = '';
        modalConfirmBtn.textContent = '確定';
        modalCancelBtn.textContent = '取消';
        modal.classList.remove('hidden');

        const confirmHandler = () => {
            if (onConfirm) onConfirm();
            modal.classList.add('hidden');
            modalConfirmBtn.removeEventListener('click', confirmHandler);
        };
        const cancelHandler = () => {
            if (onCancel) onCancel();
            modal.classList.add('hidden');
            modalConfirmBtn.removeEventListener('click', cancelHandler);
        };

        modalConfirmBtn.addEventListener('click', confirmHandler);
        modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
    }
    
    // Filter button handler
    function handleFilterClick() {
        if (currentFilter === 'pending') {
            currentFilter = 'all';
        } else {
            currentFilter = 'pending';
        }
        renderStudentsTable();
    }

    // Attach event listeners
    window.addEventListener('load', () => {
        initFirebase();
        googleLoginBtn.addEventListener('click', handleGoogleSignIn);
        addClassBtn.addEventListener('click', addClass);
        addStudentBtn.addEventListener('click', addStudent);
        importStudentsBtn.addEventListener('click', importStudents);
        addTaskBtn.addEventListener('click', addTask);
        deleteTaskBtn.addEventListener('click', deleteTask);
        showPendingBtn.addEventListener('click', handleFilterClick);
        window.updateTaskStatus = updateTaskStatus;
        window.updateTaskGrade = updateTaskGrade;
        window.updateManualScore = updateManualScore;
        window.deleteStudent = deleteStudent;
        window.toggleColumnInputMode = toggleColumnInputMode;
        window.saveTaskNote = saveTaskNote;
        window.openNoteModal = openNoteModal;
        window.closeNoteModal = closeNoteModal;
        window.saveNoteAndClose = saveNoteAndClose;
    });
</script>
</body>
</html>
